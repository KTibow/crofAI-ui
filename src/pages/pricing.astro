---
import Layout from "../layouts/Layout.astro";
import If from "../components/jinja/If.astro";
import Model from "../components/pricing/Model.astro";

const plans = [
  {
    name: "Hobby",
    planId: "hobby",
    price: "$5/month",
    description: "250 daily requests for all models",
  },
  {
    name: "Pro",
    planId: "pro",
    price: "$10/month",
    description: "1000 daily requests for all models, plus priority support",
  },
];

const devModels = [
  {
    id: "kimi-k2.5",
    quantization: "int4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.45", completion: "2.00" },
    speed: 23,
    vision: true,
  },
  {
    id: "kimi-k2-thinking",
    quantization: "Q4_0",
    context_length: 262144,
    max_completion_tokens: 262144,
    pricing: { prompt: "0.40", completion: "1.50" },
    speed: 55,
  },
  {
    id: "kimi-k2-thinking-turbo",
    quantization: "fp8",
    context_length: 262144,
    max_completion_tokens: 262144,
    pricing: { prompt: "1.00", completion: "3.00" },
    speed: 242,
  },
  {
    id: "glm-4.7-flash-eco",
    quantization: "fp8",
    context_length: 31488,
    max_completion_tokens: 8192,
    pricing: { prompt: "0.00", completion: "0.00" },
    speed: 91,
  },
  {
    id: "glm-4.7",
    quantization: "fp4",
    context_length: 202752,
    max_completion_tokens: 202752,
    pricing: { prompt: "0.40", completion: "1.40" },
    speed: 80,
  },
  {
    id: "glm-4.7-canopy",
    quantization: "fp8",
    context_length: 202752,
    max_completion_tokens: 202752,
    pricing: { prompt: "0.50", completion: "2.10" },
    speed: 62,
  },
  {
    id: "deepseek-v3.2",
    quantization: "Q4_0",
    context_length: 163840,
    max_completion_tokens: 163840,
    pricing: { prompt: "0.28", completion: "0.38" },
    speed: 111,
  },
  {
    id: "deepseek-v3.2-chat",
    quantization: "Q4_0",
    context_length: 163840,
    max_completion_tokens: 163840,
    pricing: { prompt: "0.28", completion: "0.38" },
    speed: 7,
  },
  {
    id: "deepseek-v3.2-canopy",
    quantization: "fp8",
    context_length: 163840,
    max_completion_tokens: 163840,
    pricing: { prompt: "0.35", completion: "0.45" },
    speed: 43,
  },
  {
    id: "deepseek-v3.2-speciale",
    quantization: "Q4_0",
    context_length: 163840,
    max_completion_tokens: 163840,
    pricing: { prompt: "0.35", completion: "0.45" },
    speed: 151,
  },
  {
    id: "devstral-2",
    quantization: "fp8",
    context_length: 262144,
    max_completion_tokens: 262144,
    pricing: { prompt: "0.07", completion: "0.31" },
    speed: 172,
  },
  {
    id: "kimi-k2-0905",
    quantization: "Q8_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.15", completion: "0.55" },
    speed: 232,
  },
  {
    id: "kimi-k2-0905-turbo",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 8192,
    pricing: { prompt: "0.35", completion: "1.00" },
    speed: 144,
  },
  {
    id: "glm-4.6-turbo",
    quantization: "fp8",
    context_length: 202752,
    max_completion_tokens: 202752,
    pricing: { prompt: "0.50", completion: "2.25" },
    speed: 99,
  },
  {
    id: "minimax-m2.1",
    quantization: "awq",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.28", completion: "0.90" },
    speed: 48,
  },
  {
    id: "minimax-m2.1-canopy",
    quantization: "fp8",
    context_length: 196608,
    max_completion_tokens: 196608,
    pricing: { prompt: "0.35", completion: "1.27" },
    speed: 164,
  },
  {
    id: "intellect-3",
    quantization: "Q8_0",
    context_length: 128000,
    max_completion_tokens: 128000,
    pricing: { prompt: "0.15", completion: "1.00" },
    speed: 97,
  },
  {
    id: "kimi-k2-eco",
    quantization: "Q2_k",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.05", completion: "0.10" },
    speed: 4,
  },
  {
    id: "glm-4.6",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.30", completion: "0.60" },
    speed: 182,
  },
  {
    id: "glm-4.5",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.20", completion: "0.40" },
    speed: 232,
  },
  {
    id: "ring-1t",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.40", completion: "1.00" },
    speed: 166,
  },
  {
    id: "deepseek-v3.2-exp",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.15", completion: "0.30" },
    speed: 37,
  },
  {
    id: "deepseek-v3.1-terminus",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.20", completion: "0.50" },
    speed: 14,
  },
  {
    id: "deepseek-v3.1-terminus-reasoner",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.20", completion: "0.50" },
    speed: 561,
  },
  {
    id: "deepseek-v3.1",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.15", completion: "0.50" },
    speed: 9,
  },
  {
    id: "deepseek-v3.1-reasoner",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.15", completion: "0.50" },
    speed: 122,
  },
  {
    id: "deepseek-v3-0324",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 8192,
    pricing: { prompt: "0.20", completion: "0.25" },
    speed: 242,
  },
  {
    id: "deepseek-v3-0324-turbo",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 8192,
    pricing: { prompt: "0.50", completion: "1.00" },
    speed: 576,
  },
  {
    id: "deepseek-r1-0528",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.25", completion: "0.25" },
    speed: 80,
  },
  {
    id: "deepseek-r1-0528-turbo",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "1.00", completion: "2.00" },
    speed: 40,
  },
  {
    id: "qwen3-next-80b-a3b-instruct",
    quantization: "Q8_0",
    context_length: 262144,
    max_completion_tokens: 262144,
    pricing: { prompt: "0.08", completion: "0.38" },
    speed: 174,
  },
  {
    id: "qwen3-235b-a22b-2507-instruct",
    quantization: "Q8_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.10", completion: "0.25" },
    speed: 328,
  },
  {
    id: "qwen3-235b-a22b-2507-thinking",
    quantization: "Q8_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.10", completion: "0.30" },
    speed: 482,
  },
  {
    id: "qwen3-coder",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.15", completion: "0.35" },
    speed: 252,
  },
  {
    id: "qwen3-coder-turbo",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.20", completion: "0.50" },
    speed: 238,
  },
  {
    id: "gpt-oss-120b",
    quantization: "Q4_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.07", completion: "0.27" },
    speed: 327,
  },
  {
    id: "gpt-oss-safeguard-120b",
    quantization: "Q8_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.07", completion: "0.27" },
    speed: 263,
  },
  {
    id: "gemma-3-27b-it",
    quantization: "Q8_0",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.04", completion: "0.10" },
    speed: 38,
    vision: true,
  },
  {
    id: "llama-4-scout",
    quantization: "fp8",
    context_length: 262144,
    max_completion_tokens: 16384,
    pricing: { prompt: "0.08", completion: "0.40" },
    speed: 116,
    vision: true,
  },
  {
    id: "llama3.3-70b",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 8192,
    pricing: { prompt: "0.12", completion: "0.20" },
    speed: 138,
  },
  {
    id: "deepseek-r1-distill-llama-70b",
    quantization: "fp8",
    context_length: 65536,
    max_completion_tokens: 65536,
    pricing: { prompt: "0.10", completion: "0.10" },
    speed: 109,
  },
  {
    id: "deepseek-r1-distill-qwen-32b",
    quantization: "fp8",
    context_length: 65536,
    max_completion_tokens: 65536,
    pricing: { prompt: "0.10", completion: "0.10" },
    speed: 167,
  },
  {
    id: "stok-0.4.1",
    quantization: "stok",
    context_length: 2048,
    max_completion_tokens: 2048,
    pricing: { prompt: "0.00", completion: "0.00" },
    speed: 3923,
  },
];
---

<Layout title="Pricing" footerPushToBottom={true} loggedIn="auto">
  <main>
    <h2 class="font-headline-small">With plans, never worry about prices per token</h2>
    <div class="plans">
      {
        plans.map(({ name, planId, price, description }) => (
          <>
            <If condition={`plan == '${planId}'`}>
              <a
                class="plan layer"
                href="/plan-api/free"
                onclick={`if(!confirm('Remove all ${name} priviliges?')){event.preventDefault()}`}
              >
                <h3>
                  {name} • <span class="price">{price}</span>
                </h3>
                <p>{description}</p>
                <div class="fake-button error">Unsubscribe</div>
              </a>
            </If>
            <If condition={`plan != '${planId}'`}>
              <If condition="not loggedin">
                <a class="plan layer" href="/signin">
                  <h3>
                    {name} • <span class="price">{price}</span>
                  </h3>
                  <p>{description}</p>
                  <div class="fake-button">Sign in</div>
                </a>
              </If>
              <If condition="loggedin">
                <a
                  class="plan layer"
                  href={`/plan-api/${planId}`}
                  onclick={`if(!confirm('Subscribe to ${name}?')){event.preventDefault()}`}
                >
                  <h3>
                    {name} • <span class="price">{price}</span>
                  </h3>
                  <p>{description}</p>
                  <div class="fake-button">Purchase</div>
                </a>
              </If>
            </If>
          </>
        ))
      }
    </div>
    <table class="models-table">
      <thead>
        <tr class="font-title-medium">
          <th data-sort="id">Model <span class="sort-indicator"></span></th>
          <th data-sort="prompt">$/M in <span class="sort-indicator"></span></th>
          <th data-sort="completion">$/M out <span class="sort-indicator"></span></th>
          <th data-sort="speed">Speed <span class="sort-indicator"></span></th>
        </tr>
      </thead>
      <tbody id="models-tbody">
        {
          import.meta.env.DEV ? (
            devModels.map((model) => {
              const contextK = Math.floor(model.context_length / 1024);
              const maxOutK = Math.floor(model.max_completion_tokens / 1024);
              const contextDisplay =
                model.max_completion_tokens !== model.context_length
                  ? `${contextK}k context / ${maxOutK}k output`
                  : `${contextK}k`;

              const minSpeed = 10;
              const maxSpeed = 1000;
              const speedPercent = Math.min(
                Math.max(((model.speed - minSpeed) / (maxSpeed - minSpeed)) * 100, 0),
                100,
              );
              const speedColor = `color-mix(in oklab, oklch(0.8 0.3379 164.12) ${speedPercent}%, oklch(0.8 0.0664 0))`;

              return (
                <Model
                  id={model.id}
                  quantization={model.quantization}
                  contextDisplay={contextDisplay}
                  promptPricing={model.pricing.prompt}
                  completionPricing={model.pricing.completion}
                  speed={`${model.speed}`}
                  speedStyle={`text-align: right; color: ${speedColor}`}
                />
              );
            })
          ) : (
            <>
              <Fragment set:html="{% for item in models %}" />
              <Model
                id="{{ item.id }}"
                quantization="{{ item.quantization }}"
                contextDisplay="{% if item.max_completion_tokens != item.context_length %}{{ (item.context_length / 1024) | int }}k context / {{ (item.max_completion_tokens / 1024) | int }}k output{% else %}{{ (item.context_length / 1024) | int }}k{% endif %}"
                promptPricing='{{ item.pricing["prompt"] }}'
                completionPricing='{{ item.pricing["completion"] }}'
                speed="{{ item.speed }}"
                speedStyle="text-align: right; {% set speed_val = item.speed %}{% set speed_percent = (((speed_val - 10) / (1000 - 10)) * 100) | int %}{% set speed_percent_clamped = [0, [speed_percent, 100] | min] | max %}color: color-mix(in oklab, oklch(0.8 0.3379 164.12) {{ speed_percent_clamped }}%, oklch(0.8 0.0664 0))"
              />
              <Fragment set:html="{% endfor %}" />
            </>
          )
        }
      </tbody>
    </table>
  </main>

  <script>
    let currentSort: string | null = null;
    let currentDirection: "asc" | "desc" = "asc";

    const headers = document.querySelectorAll("[data-sort]");
    headers.forEach((header) => {
      header.addEventListener("click", () => {
        const sortKey = header.getAttribute("data-sort");
        if (!sortKey) return;

        // Toggle direction if clicking same column
        if (currentSort == sortKey) {
          currentDirection = currentDirection == "asc" ? "desc" : "asc";
        } else {
          currentSort = sortKey;
          currentDirection = "asc";
        }

        // Update indicators
        headers.forEach((h) => {
          const indicator = h.querySelector(".sort-indicator");
          if (indicator) {
            if (h == header) {
              indicator.textContent = currentDirection == "asc" ? " ↑" : " ↓";
            } else {
              indicator.textContent = "";
            }
          }
        });

        sortTable(sortKey, currentDirection);
      });
    });

    function sortTable(key: string, direction: "asc" | "desc") {
      const tbody = document.getElementById("models-tbody");
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll("tr"));

      rows.sort((a, b) => {
        if (key == "id") {
          const aVal = a.getAttribute("data-id") || "";
          const bVal = b.getAttribute("data-id") || "";
          return direction == "asc" ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
          const aVal = parseFloat(a.getAttribute(`data-${key}`) || "0");
          const bVal = parseFloat(b.getAttribute(`data-${key}`) || "0");
          return direction == "asc" ? aVal - bVal : bVal - aVal;
        }
      });

      rows.forEach((row) => tbody.appendChild(row));
    }
  </script>
  <script>
    function normalizeModelId(id: string): string {
      let n = id.split("/").pop()!.split(":")[0];
      const suffixes = ["-turbo", "-eco", "-canopy", "-ultra", "-lite", "-fast"];
      for (const s of suffixes) {
        if (n.endsWith(s)) {
          n = n.slice(0, -s.length);
          break;
        }
      }
      n = n.replace("deepseek-v3", "deepseek-chat-v3");
      if (n == "llama3.3-70b") {
        n = "llama-3.3-70b-instruct";
      }
      if (n == "devstral-2") {
        n = "devstral-2512";
      }
      if (n == "qwen3-235b-a22b-2507") {
        n = "qwen3-235b-a22b-2507-instruct";
      }
      if (n == "qwen3-235b-a22b-thinking-2507") {
        n = "qwen3-235b-a22b-2507-thinking";
      }
      return n;
    }

    async function enhanceWithPriceComparison() {
      const response = await fetch("https://openrouter.ai/api/v1/models");
      if (!response.ok) return;

      const { data: orModels } = await response.json();

      document.querySelectorAll("#models-tbody tr").forEach((row) => {
        const modelId = row.getAttribute("data-id");
        if (!modelId) return;

        const ourPrompt = parseFloat(row.getAttribute("data-prompt") || "0");
        const ourCompletion = parseFloat(row.getAttribute("data-completion") || "0");
        const isFree = ourPrompt == 0 && ourCompletion == 0;
        const normalizedId = normalizeModelId(modelId);

        let minP = Infinity,
          minC = Infinity;
        for (const m of orModels || []) {
          if (!m.pricing) continue;
          if (!isFree && m.id.endsWith(":free")) continue;
          if (normalizeModelId(m.id) == normalizedId) {
            minP = Math.min(minP, parseFloat(m.pricing.prompt) * 1e6);
            minC = Math.min(minC, parseFloat(m.pricing.completion) * 1e6);
          }
        }

        const container = row.querySelector(".chips")!;
        if (minP == Infinity) {
          console.debug(`No OpenRouter pricing found for model ${modelId}`);
          return;
        }

        const chip = document.createElement("div");
        chip.className = "chip savings-chip font-label-medium";

        if (isFree) {
          chip.textContent = "free";
          chip.title = `vs OpenRouter's $${minP.toFixed(2)}/$${minC.toFixed(2)}`;
        } else {
          const savings = Math.floor(
            Math.min(
              minP > 0 ? (minP - ourPrompt) / minP : 0,
              minC > 0 ? (minC - ourCompletion) / minC : 0,
            ) * 100,
          );

          if (savings < 5) return;
          chip.textContent = `${savings}% cheaper`;
          chip.title = `vs OpenRouter's $${minP.toFixed(2)}/${minC.toFixed(2)}`;
        }
        container.appendChild(chip);
      });
    }

    enhanceWithPriceComparison();
  </script>
</Layout>

<style>
  main {
    display: flex;
    flex-direction: column;

    align-self: center;
    width: 100%;
    max-width: 50rem;
  }
  h2 {
    margin-top: 1.5rem;
  }
  .plans {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  .plan {
    display: flex;
    flex-direction: column;
    text-align: start;

    padding: 1rem;
    border-radius: 1.5rem;
    background-color: var(--m3c-surface-container);
    cursor: pointer;

    > h3 {
      font-weight: bold;
    }
    .price {
      color: var(--m3c-primary);
    }
    > p {
      margin-bottom: 0.5rem;
    }
    > .fake-button {
      display: flex;
      align-items: center;
      align-self: end;
      height: 3rem;
      border-radius: 1.5rem;

      padding-inline: 1rem;

      background-color: var(--m3c-primary);
      color: var(--m3c-on-primary);
      &.error {
        background-color: var(--m3c-error);
        color: var(--m3c-on-error);
      }

      margin-top: auto;
      margin-right: -1rem;
      margin-bottom: -1rem;
    }
  }

  .models-table {
    width: 100%;
    border-collapse: collapse;
    font-feature-settings: "tnum";
    margin-top: 3rem;
  }

  .models-table th {
    cursor: pointer;
    user-select: none;
  }

  .models-table th:first-child {
    text-align: left;
  }

  .models-table th:not(:first-child) {
    text-align: right;
  }

  .models-table :global(th),
  .models-table :global(td) {
    margin: 0;
    padding: 0;
    border: none;
    padding-block: 0.5rem;
  }
  .models-table :global(tr:not(tbody > :last-child)) {
    border-bottom: 1px solid var(--m3c-outline-variant);
  }
</style>
