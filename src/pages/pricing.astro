---
import Layout from "../layouts/Layout.astro";
import If from "../components/jinja/If.astro";
import Model from "../components/pricing/Model.astro";

const plans = [
  {
    name: "Hobby",
    planId: "hobby",
    price: "$5/month",
    description: "250 daily requests for all models",
  },
  {
    name: "Pro",
    planId: "pro",
    price: "$10/month",
    description: "1000 daily requests for all models, plus priority support",
  },
];

// Dev data
const devModels = [
  {
    id: "kimi-k2-thinking",
    quantization: "fp4",
    context_length: 262144,
    max_completion_tokens: 262144,
    pricing: { prompt: "0.00", completion: "0.00" },
    speed: 77,
  },
  {
    id: "kimi-k2-thinking-turbo",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "1.00", completion: "2.25" },
    speed: 15,
  },
  {
    id: "kimi-k2-0905",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.15", completion: "0.55" },
    speed: 33,
  },
  {
    id: "kimi-k2-0905-turbo",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 8192,
    pricing: { prompt: "0.35", completion: "1.00" },
    speed: 685,
  },
  {
    id: "glm-4.6-turbo",
    quantization: "fp8",
    context_length: 202752,
    max_completion_tokens: 202752,
    pricing: { prompt: "0.50", completion: "2.25" },
    speed: 25,
  },
  {
    id: "minimax-m2",
    quantization: "fp8",
    context_length: 196608,
    max_completion_tokens: 196608,
    pricing: { prompt: "0.00", completion: "0.00" },
    speed: 140,
  },
  {
    id: "deepseek-v3.1:free",
    quantization: "fp8",
    context_length: 128000,
    max_completion_tokens: 128000,
    pricing: { prompt: "0.00", completion: "0.00" },
    speed: 79,
  },
  {
    id: "qwen3-coder:free",
    quantization: "fp8",
    context_length: 256000,
    max_completion_tokens: 256000,
    pricing: { prompt: "0.00", completion: "0.00" },
    speed: 73,
  },
  {
    id: "kimi-k2-eco",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.05", completion: "0.10" },
    speed: 16,
  },
  {
    id: "glm-4.6",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.30", completion: "0.60" },
    speed: 129,
  },
  {
    id: "glm-4.5",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.20", completion: "0.40" },
    speed: 165,
  },
  {
    id: "ring-1t",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.40", completion: "1.00" },
    speed: 112,
  },
  {
    id: "deepseek-v3.2-exp",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.15", completion: "0.30" },
    speed: 164,
  },
  {
    id: "deepseek-v3.1-terminus",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.20", completion: "0.50" },
    speed: 26,
  },
  {
    id: "deepseek-v3.1-terminus-reasoner",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.20", completion: "0.50" },
    speed: 45,
  },
  {
    id: "deepseek-v3.1",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.15", completion: "0.50" },
    speed: 8,
  },
  {
    id: "deepseek-v3.1-reasoner",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.15", completion: "0.50" },
    speed: 88,
  },
  {
    id: "deepseek-v3-0324",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 8192,
    pricing: { prompt: "0.20", completion: "0.25" },
    speed: 33,
  },
  {
    id: "deepseek-v3-0324-turbo",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 8192,
    pricing: { prompt: "0.50", completion: "1.00" },
    speed: 22,
  },
  {
    id: "deepseek-r1-0528",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.25", completion: "0.25" },
    speed: 33,
  },
  {
    id: "deepseek-r1-0528-turbo",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "1.00", completion: "2.00" },
    speed: 125,
  },
  {
    id: "qwen3-next-80b-a3b-instruct",
    quantization: "fp8",
    context_length: 262144,
    max_completion_tokens: 262144,
    pricing: { prompt: "0.08", completion: "0.38" },
    speed: 24,
  },
  {
    id: "qwen3-235b-a22b-2507-instruct",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.10", completion: "0.25" },
    speed: 96,
  },
  {
    id: "qwen3-235b-a22b-2507-thinking",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.10", completion: "0.30" },
    speed: 40,
  },
  {
    id: "qwen3-coder",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.15", completion: "0.35" },
    speed: 71,
  },
  {
    id: "qwen3-coder-turbo",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.20", completion: "0.50" },
    speed: 254,
  },
  {
    id: "gpt-oss-120b",
    quantization: "fp4",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.07", completion: "0.27" },
    speed: 148,
  },
  {
    id: "gpt-oss-safeguard-120b",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.07", completion: "0.27" },
    speed: 135,
  },
  {
    id: "gemma-3-27b-it",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 131072,
    pricing: { prompt: "0.04", completion: "0.10" },
    speed: 81,
  },
  {
    id: "llama-4-scout",
    quantization: "fp8",
    context_length: 262144,
    max_completion_tokens: 16384,
    pricing: { prompt: "0.08", completion: "0.40" },
    speed: 65,
  },
  {
    id: "llama3.3-70b",
    quantization: "fp8",
    context_length: 131072,
    max_completion_tokens: 8192,
    pricing: { prompt: "0.12", completion: "0.20" },
    speed: 31,
  },
  {
    id: "deepseek-r1-distill-llama-70b",
    quantization: "fp4",
    context_length: 65536,
    max_completion_tokens: 65536,
    pricing: { prompt: "0.10", completion: "0.10" },
    speed: 64,
  },
  {
    id: "deepseek-r1-distill-qwen-32b",
    quantization: "fp4",
    context_length: 65536,
    max_completion_tokens: 65536,
    pricing: { prompt: "0.10", completion: "0.10" },
    speed: 65,
  },
  {
    id: "stok-0.4.1",
    quantization: "stok",
    context_length: 2048,
    max_completion_tokens: 2048,
    pricing: { prompt: "0.00", completion: "0.00" },
    speed: 4720,
  },
];
---

<Layout title="Pricing" footerPushToBottom={true} loggedIn="auto">
  <main>
    <h2 class="font-headline-small">With plans, never worry about prices per token</h2>
    <div class="plans">
      {
        plans.map(({ name, planId, price, description }) => (
          <>
            <If condition={`plan == '${planId}'`}>
              <a
                class="plan layer"
                href="/plan-api/free"
                onclick={`if(!confirm('Remove all ${name} priviliges?')){event.preventDefault()}`}
              >
                <h3>
                  {name} • <span class="price">{price}</span>
                </h3>
                <p>{description}</p>
                <div class="fake-button error">Unsubscribe</div>
              </a>
            </If>
            <If condition={`plan != '${planId}'`}>
              <If condition="not loggedin">
                <a class="plan layer" href="/signin">
                  <h3>
                    {name} • <span class="price">{price}</span>
                  </h3>
                  <p>{description}</p>
                  <div class="fake-button">Sign in</div>
                </a>
              </If>
              <If condition="loggedin">
                <a
                  class="plan layer"
                  href={`/plan-api/${planId}`}
                  onclick={`if(!confirm('Subscribe to ${name}?')){event.preventDefault()}`}
                >
                  <h3>
                    {name} • <span class="price">{price}</span>
                  </h3>
                  <p>{description}</p>
                  <div class="fake-button">Purchase</div>
                </a>
              </If>
            </If>
          </>
        ))
      }
    </div>
    <table class="models-table">
      <thead>
        <tr class="font-title-medium">
          <th data-sort="id">Model <span class="sort-indicator"></span></th>
          <th data-sort="prompt">$/M in <span class="sort-indicator"></span></th>
          <th data-sort="completion">$/M out <span class="sort-indicator"></span></th>
          <th data-sort="speed">Speed <span class="sort-indicator"></span></th>
        </tr>
      </thead>
      <tbody id="models-tbody">
        {
          import.meta.env.DEV ? (
            devModels.map((model) => {
              const contextK = Math.floor(model.context_length / 1024);
              const maxOutK = Math.floor(model.max_completion_tokens / 1024);
              const contextDisplay =
                model.max_completion_tokens !== model.context_length
                  ? `${contextK}k context / ${maxOutK}k output`
                  : `${contextK}k`;

              const minSpeed = 10;
              const maxSpeed = 1000;
              const speedPercent = Math.min(
                Math.max(((model.speed - minSpeed) / (maxSpeed - minSpeed)) * 100, 0),
                100,
              );
              const speedColor = `color-mix(in oklab, oklch(0.8 0.3379 164.12) ${speedPercent}%, oklch(0.8 0.0664 0))`;

              return (
                <Model
                  id={model.id}
                  quantization={model.quantization}
                  contextDisplay={contextDisplay}
                  promptPricing={model.pricing.prompt}
                  completionPricing={model.pricing.completion}
                  speed={`${model.speed}`}
                  speedStyle={`text-align: right; color: ${speedColor}`}
                />
              );
            })
          ) : (
            <>
              <Fragment set:html="{% for item in models %}" />
              <Model
                id="{{ item.id }}"
                quantization="{{ item.quantization }}"
                contextDisplay="{% if item.max_completion_tokens != item.context_length %}{{ (item.context_length / 1024) | int }}k context / {{ (item.max_completion_tokens / 1024) | int }}k output{% else %}{{ (item.context_length / 1024) | int }}k{% endif %}"
                promptPricing='{{ item.pricing["prompt"] }}'
                completionPricing='{{ item.pricing["completion"] }}'
                speed="{{ item.speed }}"
                speedStyle="text-align: right; {% set speed_val = item.speed %}{% set speed_percent = (((speed_val - 10) / (1000 - 10)) * 100) | int %}{% set speed_percent_clamped = [0, [speed_percent, 100] | min] | max %}color: color-mix(in oklab, oklch(0.8 0.3379 164.12) {{ speed_percent_clamped }}%, oklch(0.8 0.0664 0))"
              />
              <Fragment set:html="{% endfor %}" />
            </>
          )
        }
      </tbody>
    </table>
  </main>

  <script>
    let currentSort: string | null = null;
    let currentDirection: "asc" | "desc" = "asc";

    const headers = document.querySelectorAll("[data-sort]");
    headers.forEach((header) => {
      header.addEventListener("click", () => {
        const sortKey = header.getAttribute("data-sort");
        if (!sortKey) return;

        // Toggle direction if clicking same column
        if (currentSort == sortKey) {
          currentDirection = currentDirection == "asc" ? "desc" : "asc";
        } else {
          currentSort = sortKey;
          currentDirection = "asc";
        }

        // Update indicators
        headers.forEach((h) => {
          const indicator = h.querySelector(".sort-indicator");
          if (indicator) {
            if (h == header) {
              indicator.textContent = currentDirection == "asc" ? " ↑" : " ↓";
            } else {
              indicator.textContent = "";
            }
          }
        });

        sortTable(sortKey, currentDirection);
      });
    });

    function sortTable(key: string, direction: "asc" | "desc") {
      const tbody = document.getElementById("models-tbody");
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll("tr"));

      rows.sort((a, b) => {
        if (key == "id") {
          const aVal = a.getAttribute("data-id") || "";
          const bVal = b.getAttribute("data-id") || "";
          return direction == "asc" ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
          const aVal = parseFloat(a.getAttribute(`data-${key}`) || "0");
          const bVal = parseFloat(b.getAttribute(`data-${key}`) || "0");
          return direction == "asc" ? aVal - bVal : bVal - aVal;
        }
      });

      rows.forEach((row) => tbody.appendChild(row));
    }
  </script>
</Layout>

<style>
  main {
    display: flex;
    flex-direction: column;

    align-self: center;
    width: 100%;
    max-width: 50rem;
  }
  h2 {
    margin-top: 1.5rem;
  }
  .plans {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  .plan {
    display: flex;
    flex-direction: column;
    text-align: start;
    position: relative;

    padding: 1rem;
    border-radius: 1.5rem;
    background-color: rgb(var(--m3-scheme-surface-container));
    cursor: pointer;

    > h3 {
      font-weight: bold;
    }
    .price {
      color: rgb(var(--m3-scheme-primary));
    }
    > p {
      margin-bottom: 0.5rem;
    }
    > .fake-button {
      display: flex;
      align-items: center;
      align-self: end;
      height: 3rem;
      border-radius: 1.5rem;

      padding-inline: 1rem;

      background-color: rgb(var(--m3-scheme-primary));
      color: rgb(var(--m3-scheme-on-primary));
      &.error {
        background-color: rgb(var(--m3-scheme-error));
        color: rgb(var(--m3-scheme-on-error));
      }

      margin-top: auto;
      margin-right: -1rem;
      margin-bottom: -1rem;
    }
  }

  .models-table {
    width: 100%;
    border-collapse: collapse;
    font-feature-settings: "tnum";
    margin-top: 3rem;
  }

  .models-table th {
    cursor: pointer;
    user-select: none;
  }

  .models-table th:first-child {
    text-align: left;
  }

  .models-table th:not(:first-child) {
    text-align: right;
  }

  .models-table :global(th),
  .models-table :global(td) {
    margin: 0;
    padding: 0;
    border: none;
    padding-block: 0.5rem;
  }
  .models-table :global(tr:not(tbody > :last-child)) {
    border-bottom: 1px solid rgb(var(--m3-scheme-outline-variant));
  }
</style>
