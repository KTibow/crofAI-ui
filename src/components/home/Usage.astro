---
import If from "../jinja/If.astro";

const credits = import.meta.env.DEV ? "2.00" : "{{ user_credits }}";
const requestsRemaining = import.meta.env.DEV ? "100" : "{{ usable_requests }}";
const requestsTotal = import.meta.env.DEV ? "250" : "{{ requests_plan }}";
const requestsAllTime = import.meta.env.DEV ? "999" : "{{ free_requests }}";
---

<div class="grid">
  <div class="box">
    <p class="font-headline-small">$<span class="credits">{credits}</span></p>
    <h2 class="font-title-medium">Credits</h2>
  </div>
  <div class="box">
    <If condition="usable_requests != None">
      <p class="font-headline-small">{requestsRemaining}/{requestsTotal} this month</p>
      <p>({requestsAllTime} used all time)</p>
    </If>
    <If condition="usable_requests == None">
      <p class="font-headline-small">{requestsAllTime} all time</p>
    </If>
    <p class="font-title-medium">Requests</p>
  </div>
  <div class="tokens-anchor">Loading...</div>
</div>

<script>
  const creditsElement = document.querySelector(".credits")!;
  setInterval(async () => {
    const r = await fetch("/user-api/credits");
    const newCredits = await r.json();
    creditsElement.textContent = newCredits;
  }, 10000);
</script>
<script>
  const tokensAnchor = document.querySelector(".tokens-anchor")!;
  const loadTokens = async () => {
    const r = await fetch("/user-api/usage");
    const tokens: Record<
      string,
      { input_tokens: number; output_tokens: number; total_tokens: number }
    > = await r.json();

    // Calculate totals
    const modelData = Object.entries(tokens)
      .map(([model, data]) => ({
        model,
        ...data,
      }))
      .sort((a, b) => b.total_tokens - a.total_tokens)
      .slice(0, 12);

    const maxTokens = Math.max(...modelData.map((d) => d.total_tokens), 1);

    // Render the chart
    tokensAnchor.innerHTML = modelData
      .map((data) => {
        const inputPercent = (data.input_tokens / maxTokens) * 100;
        const outputPercent = (data.output_tokens / maxTokens) * 100;

        return `<div class="token-row font-body-medium">
  <div class="token-label">${data.model}</div>
  <div class="token-bar">
    <div class="token-input" title="Input" style="width: ${inputPercent}%"></div>
    <div class="token-output" title="Output" style="width: ${outputPercent}%"></div>
  </div>
  <div class="token-total">${data.total_tokens.toLocaleString()}</div>
</div>`;
      })
      .join("");
  };
  loadTokens();
</script>

<style>
  .grid {
    display: grid;
    gap: 0.5rem;

    @media (width >= 40rem) {
      grid-template-columns: 10rem 1fr;
    }

    margin-top: 1.5rem;

    width: min(calc(100% - 2rem), 50rem);
    align-self: center;
  }

  .box {
    display: flex;
    flex-direction: column;
    padding: 0.5rem;
    border-radius: 1.5rem;
    min-height: 10rem;

    background-color: var(--m3c-surface-container-low);
    grid-column: 1;

    > :nth-child(2) {
      margin-top: auto;
      padding-top: 1rem;
    }
    > :not(.font-headline-small, .font-title-medium) {
      color: var(--m3c-on-surface-variant);
    }
  }

  :global(.tokens-anchor) {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;

    padding: 0.5rem;
    border-radius: 1.5rem;
    background-color: var(--m3c-surface-container-low);

    @media (width >= 40rem) {
      grid-column: 2;
      grid-row: 1 / span 2;
    }
  }

  :global(.token-row) {
    display: grid;
    grid-template-columns: 8rem 1fr auto;
    height: 1lh;
    gap: 0.5rem;
  }

  :global(.token-label) {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    align-self: center;
  }

  :global(.token-bar) {
    display: flex;
    gap: 0.125rem;
    position: relative;

    .token-input {
      background-color: var(--m3c-tertiary);
      border-radius: 0.25rem;
    }

    .token-output {
      background-color: var(--m3c-primary);
      border-radius: 0.25rem;
    }
  }

  :global(.token-total) {
    text-align: right;
    font-variant-numeric: tabular-nums;
    align-self: center;
  }
</style>
